import{g as X,m as Z,B as Q,_ as D,o as d,c,b as s,n as C,t as b,F as y,l as w,d as I,w as L,v as H,D as tt,E as J,G as k,H as x,I as K,J as R,K as et,h as P,j as W,L as st,p as at,k as ot,f as nt,s as lt}from"./_plugin-vue_export-helper-1486c17a.js";import{z as it,m as U,i as rt,s as T}from"./viridis-8fe3572d.js";function V(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}const dt=X({name:"MapCleanData",props:{data:{type:Array,required:!0},modes:{type:Array,required:!0}},emits:["mode-change","polygon-clicked"],data(){return{mode:"districts",polygons:null,path:null,svg:null,projection:null,colors:null,max:null,height:500,width:500,zoomTransform:0,tooltip:null,showMap:!1}},watch:{mode(t){this.$emit("mode-change",t)},data(t){console.log("data changed"),this.init()}},computed:{...Z({geojson:t=>t.data.geojson}),current_geojson(){return!this.geojson||!this.mode?{}:this.geojson[this.mode]},zoom(){return it().scaleExtent([.5,250]).translateExtent([[-.5*this.width,-.75*this.height],[2.5*this.width,2.5*this.height]]).on("zoom",this.handleZoom)},mode_key(){return{countries:"country",states:"state",districts:"district"}[this.mode]}},created(){this.geojson&&this.geojson.features&&(console.log("mounted: initializing"),this.init())},updated(){console.log("updated: re-initializing"),this.init()},methods:{init(){this.showMap&&this.current_geojson.features?(this.init_variables(),this.init_svg(),this.render_map()):console.log("No geojson")},init_variables(){this.polygons=null,this.path=null,this.svg={},this.height=window.innerHeight*.8,this.width=window.innerWidth*.5,window.innerWidth<800?(this.height=window.innerHeight*.6,this.projection=U().scale(600).center([110,20])):this.projection=U().scale(1e3).center([80,27.5]),this.path=rt().projection(this.projection),this.tooltip=this.init_tooltip()},init_tooltip(){return T("body .d3-tooltip").empty()||T("body .d3-tooltip").remove(),T("body").append("div").attr("class","d3-tooltip").style("position","absolute").style("top","0").style("z-index","2000").style("visibility","hidden").style("padding","10px").style("background","rgba(0,0,0,0.75)").style("border-radius","4px").style("color","#fff").text("a simple tooltip")},init_svg(){T("#map-container svg.svg-content").empty()||T("#map-container svg.svg-content").remove(),this.svg=T("#map-container").append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("width",this.width).attr("height",this.height).classed("svg-content",!0),this.zoomTransform||(this.zoomTransform=Q(this.svg.node()))},render_map(){let t=this.svg.append("g").classed("map-boundary",!0).selectAll("path").append("g");this.svg.append("g").classed("map-labels",!0).selectAll("text").append("g"),this.polygons=t.append("g").classed("polygons",!0),this.current_geojson.features.forEach(e=>{this.drawPolygon(e)}),this.drawPoints(),this.svg.call(this.zoom),this.svg.call(this.zoom.transform,this.zoomTransform)},drawPoints(){const t=this.svg.append("g").classed("points",!0),e=[];this.data.forEach(l=>{const{longitude:n,latitude:i}=l;if(i&&!isNaN(i)&&n&&!isNaN(n)){const[u,a]=this.projection([n,i]);t.append("circle").attr("cx",u).attr("cy",a).attr("r","10px").classed("point",!0)}else e.push(l)}),e.length&&console.warn("Missing Coordinates:",e)},drawPolygon(t){this.polygons.append("g").data([t]).enter().append("path").attr("d",this.path).classed("polygon",!0).on("mouseover",(e,l)=>{this.tooltip.html(this.hover_text(t.properties)).style("visibility","visible")}).on("mousemove",(e,l)=>{this.tooltip.style("top",e.pageY-10+"px").style("left",e.pageX+10+"px")}).on("mouseout",()=>this.tooltip.html("").style("visibility","hidden")).on("click",(e,l)=>this.clicked(l))},getPolygonId(t){let e=t.region,l=[" ","&","(",")","."];return t.state!=null&&(e=t.state),t.district!=null&&(e=t.district),l.forEach(n=>{e=e.replaceAll(n,"_")}),e},clicked(t){console.log(t);const{state:e,district:l}=t.properties;let n=[];e&&n.push(e),l&&n.push(l),n.length&&(n=n.join(" "),navigator.clipboard.writeText(n))},drawPolygonBoundary(t){this.polygons.append("g").data([t]).enter().append("path").classed("state-boundary",!0).classed("selected-polygon",e=>this.selected.state&&e.properties.state==this.selected.state||this.selected.region&&e.properties.region==this.selected.region).attr("properties",e=>JSON.stringify(e.properties)).attr("d",this.path).attr("id",this.getPolygonId(t.properties))},drawPolygonLabel(t,e){const l=this.regional_data[this.polygon_mode].find(i=>i[this.polygon_key]==e.properties[this.polygon_key]);let n="";l&&(n=this.format_number(l[this.data_mode])),t.append("g").data([e]).enter().append("text").classed("poly_text",!0).attr("x",i=>this.path.centroid(i)[0]).attr("y",i=>this.path.centroid(i)[1]).classed("small-text",!0).attr("text-anchor","middle").text(n).on("mouseover",()=>{this.tooltip.html(this.hover_text(e.properties)).style("visibility","visible")}).on("mousemove",(i,u)=>{this.tooltip.style("top",i.pageY-10+"px").style("left",i.pageX+10+"px")}).on("mouseout",()=>this.tooltip.html("").style("visibility","hidden")).on("click",(i,u)=>this.clicked(u))},color_polygon(t){let e=this.mapData.find(l=>l.name==t[this.mode_key]);return e?this.colors(e.value):this.colors(0)},handleZoom(t){this.zoomTransform=t.transform;let e=1/t.transform.k*.8;this.svg.selectAll(".poly_text").attr("transform",t.transform).style("font-size",`${e}rem`),this.svg.selectAll("path").attr("transform",t.transform),this.svg.selectAll("circle").attr("transform",t.transform).attr("r",e*5)},hover_text(t){let e=Object.entries(t).filter(([l,n])=>l!="id");return e=e.map(([l,n])=>`<tr><td>${V(l)}</td><td>${V(n)}</td></tr>`),`<table border='1' class='d3-tooltip'>${e.join(`
`)}</table>`},format_number(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}}),ct={class:"text-center"},ut={key:0,class:"main-container"},pt={class:"switcher switcher-sm text-center py-2 bg-dark"},ht=["onClick","textContent"],vt=s("div",{id:"map"},[s("div",{id:"map-container"})],-1);function gt(t,e,l,n,i,u){return d(),c(y,null,[s("div",ct,[s("button",{class:C(["btn",t.showMap?"btn-danger btn-sm":"btn-success btn-lg"]),onClick:e[0]||(e[0]=a=>t.showMap=!t.showMap)},b(t.showMap?"Hide":"Show")+" Map ",3)]),t.showMap?(d(),c("div",ut,[s("div",pt,[(d(!0),c(y,null,w(t.modes,a=>(d(),c("button",{class:C(["btn mx-1",a===t.mode?"btn-success":"btn-outline-success bg-light"]),key:a,onClick:f=>t.mode=a,textContent:b(a)},null,10,ht))),128))]),vt])):I("",!0)],64)}const mt=D(dt,[["render",gt]]);const _t={name:"AutoComplete",props:{suggestions:{type:Array,required:!0},value:{type:String,required:!0}},emits:["selected"],data(){return{searchText:"",showSuggestions:!1,filteredSuggestions:[],typingTimer:null,typingTimeout:300}},watch:{value(t,e){this.searchText=t,e.length==0&&this.handleInput()}},methods:{handleInput(){clearTimeout(this.typingTimer),this.searchText.length>=2?this.typingTimeout=setTimeout(()=>{this.filteredSuggestions=this.suggestions.filter(t=>t.toLowerCase().includes(this.searchText.toLowerCase())),this.showSuggestions=!0},this.typingTimeout):(this.filteredSuggestions=[],this.showSuggestions=!1)},selectSuggestion(t){this.searchText=t,this.showSuggestions=!1,this.$emit("selected",t)}}},bt={key:0},ft=["onClick"];function yt(t,e,l,n,i,u){return d(),c(y,null,[L(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>i.searchText=a),placeholder:"Enter Taxon",class:"form-control",onInput:e[1]||(e[1]=(...a)=>u.handleInput&&u.handleInput(...a)),onKeydown:e[2]||(e[2]=tt((...a)=>u.selectSuggestion&&u.selectSuggestion(...a),["enter"]))},null,544),[[H,i.searchText]]),i.showSuggestions?(d(),c("ul",bt,[(d(!0),c(y,null,w(i.filteredSuggestions,(a,f)=>(d(),c("li",{key:f,onClick:$=>u.selectSuggestion(a)},b(a),9,ft))),128))])):I("",!0)],64)}const xt=D(_t,[["render",yt],["__scopeId","data-v-e12b96f2"]]);const wt=t=>(at("data-v-e7d583ba"),t=t(),ot(),t),kt={key:0,class:"modal fade show","aria-modal":"true",role:"dialog"},Ct={class:"modal-dialog modal-lg"},$t={class:"modal-content"},St={class:"modal-header"},Tt={class:"modal-title",id:"exampleModalLiveLabel"},Mt={class:"modal-body"},jt={class:"form-container"},zt=["onUpdate:modelValue"],At={for:"exampleInputEmail1",class:"form-label"},Nt={class:"taxa-lookup-container p-2 row mx-0",style:{"background-color":"#aaa"}},It={class:"col"},Dt={class:"form-check form-switch"},Ot=wt(()=>s("label",{class:"form-check-label",for:"flexSwitchCheckChecked"},"validated",-1)),Et={key:1,class:"modal-backdrop fade show"},Bt={name:"ModalEditObservation",props:{show:{type:Boolean,default:!1},data:{type:Object,required:!0}},mounted(){},computed:{show_map(){return this.data.latitude&&this.data.longitude&&(this.data.state==null||this.data.district==null)}},watch:{show(t){this.current_district_coordinator_id=0;let e=document.querySelector("body");t==!0?e.classList.add("modal-open"):e.classList.remove("modal-open")}},methods:{}},Lt=Object.assign(Bt,{props:{show:{type:Boolean,default:!1},data:{type:Object,required:!0}},emits:["close"],setup(t,{emit:e}){const l=t,n=J(),i=k(()=>{const{latitude:p,longitude:g}=a.value;return[{latitude:p,longitude:g}]}),u=()=>{h.value="",e("close")},a=x({}),f=["user","observed_on","place","country","state","district","latitude","longitude","taxa_id","species"];k(()=>l.data.state==null||l.data.district==null),K(()=>l.data,p=>{a.value=JSON.parse(JSON.stringify(p))});const $=p=>{const g={present:"border border-success",absent:"border border-danger"};if(p==="place"||p==="species")return"border border-secondary";const m=a.value[p];return p==="observed_on"?S(m)?g.present:g.absent:m&&typeof m=="string"&&m.length>1||typeof m=="number"&&m>0?g.present:g.absent},S=p=>!p||/^(202[0-3])-09-\d{2}$/.test(p),M=()=>{n.dispatch("clean_data/updateData",a.value),u()};R(()=>{n.dispatch("data/getTaxa",a.value)});const j=k(()=>n.state.data.taxa.map(p=>`${p.name}-${p.id}`)),h=x(""),z=p=>{const g=p.split("-");console.log(a.value,g),a.value.species===g[0]&&a.value.taxa_id==null&&(a.value.taxa_id=g[1]),h.value=p},O=()=>{h.value=a.value.species};return(p,g)=>(d(),c(y,null,[t.show?(d(),c("div",kt,[s("div",Ct,[s("div",$t,[s("div",St,[s("h3",Tt,"Observation Details ["+b(t.data.portal)+" # "+b(t.data.id)+"]",1),s("button",{type:"button",class:"btn-close",onClick:u})]),s("div",Mt,[s("div",jt,[(d(),c(y,null,w(f,m=>s("div",{class:"form-floating",key:m},[L(s("input",{class:C(["form-control",$(m)]),"onUpdate:modelValue":E=>a.value[m]=E},null,10,zt),[[H,a.value[m]]]),s("label",At,b(et(V)(m)),1)])),64))]),s("div",Nt,[s("div",It,[P(xt,{suggestions:j.value,value:h.value,onSelected:z},null,8,["suggestions","value"])]),s("div",{class:"col-1"},[s("button",{class:"btn btn-success px-2 ms-3",onClick:O},"📋")])]),W(" "+b(h.value)+" ",1),s("div",Dt,[L(s("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":g[0]||(g[0]=m=>a.value.validated=m)},null,512),[[st,a.value.validated]]),Ot]),s("div",null,[P(mt,{data:i.value,modes:["countries","states","districts"]},null,8,["data"])])]),s("div",{class:"modal-footer"},[s("button",{type:"button",class:"btn btn-secondary",onClick:u},"Close"),s("button",{type:"button",class:"btn btn-success",onClick:M},"Save changes")])])])])):I("",!0),t.show?(d(),c("div",Et)):I("",!0)],64))}}),Pt=D(Lt,[["__scopeId","data-v-e7d583ba"]]);const Vt={class:"btn-rows bg-secondary"},qt={class:"btn-group w-100 p-1"},Ut=["textContent","onClick"],Ht={class:"btn-group w-100 p-1"},Jt=["textContent","onClick"],Kt={class:"page-info"},Rt={key:0,class:"table-container border border-danger"},Wt={class:"table table-sm table-hover"},Yt={class:"bg-dark text-light"},Ft=["textContent","onClick"],Gt=["onClick"],Xt=["textContent"],Zt={__name:"CleanData",setup(t){const e=J(),l=["counts","inat","ibp","ifb"],n=x(null),i=["all","validated","unvalidated"],u=x("unvalidated"),a=x("id"),f=x("asc"),$=x(1e3),S=x(1),M=x(!1),j=x({});R(()=>{e.dispatch("data/getMaps")}),K(n,(r,_)=>{r!==_&&e.dispatch("clean_data/getData",r)});const h=k(()=>e.getters["clean_data/data_with_classes"]),z=k(()=>{let r=[];if(h&&h.value&&h.value[0])switch(u.value){case"all":r=h.value;break;case"validated":r=h.value.filter(_=>_.validated);break;case"unvalidated":r=h.value.filter(_=>!_.validated);break}return r}),O=k(()=>{const r=(S.value-1)*$.value,_=r+$.value;return z.value.slice(r,_)}),p=k(()=>h&&h.value&&h.value[0]?O.value.sort((r,_)=>{const o=r[a.value],v=_[a.value],B=N=>!isNaN(N),A=N=>typeof N=="boolean";return B(o)&&B(v)||A(o)&&A(v)?f.value==="asc"?o-v:v-o:f.value==="asc"?o.localeCompare(v):v.localeCompare(o)}):[]),g=k(()=>h&&h.value&&h.value[0]?["id","user","observed_on","place","country","state","district","latitude","longitude","taxa_id","species","validated"]:[]),m=r=>{a.value===r?f.value=f.value==="asc"?"desc":"asc":(a.value=r,f.value="asc"),console.log(r,a.value,f.value)},E=r=>{j.value={...r,portal:n.value},M.value=!0},Y=()=>{j.value={},M.value=!1},F=r=>r.classes.all?"table-success":"table-danger",G=(r,_)=>{const v={observed_on:"classes.date",user:"classes.user",country:"classes.location.country",state:"classes.location.state",district:"classes.location.district",latitude:"classes.location.latitude",longitude:"classes.location.longitude",taxa_id:"classes.taxon.taxa_id",species:"classes.taxon.species",validated:"validated"}[_];return v?v.split(".").reduce((A,N)=>A&&A[N],r)?"table-success":"table-danger":"table-warning"};return(r,_)=>(d(),c(y,null,[s("div",Vt,[s("div",qt,[(d(),c(y,null,w(l,o=>s("button",{class:C(["btn btn-sm mx-2 rounded",{"btn-success":o===n.value,"btn-outline-light":o!==n.value}]),key:o,textContent:b(o),onClick:v=>n.value=n.value==o?null:o},null,10,Ut)),64))]),s("div",Ht,[(d(),c(y,null,w(i,o=>s("button",{class:C(["btn btn-sm mx-2 rounded",{"btn-success":o===u.value,"btn-outline-light":o!==u.value}]),key:o,textContent:b(o),onClick:v=>u.value=u.value==o?null:o},null,10,Jt)),64))]),s("div",Kt,[s("button",{class:"btn btn-sm btn-info",onClick:_[0]||(_[0]=o=>S.value--)}," < "),s("span",null,"Page "+b(S.value)+" of "+b(Math.ceil(z.value.length/$.value)),1),s("button",{class:"btn btn-sm btn-info",onClick:_[1]||(_[1]=o=>S.value++)}," > "),W(" Total Records: "+b(z.value.length),1)])]),n.value?(d(),c("div",Rt,[s("table",Wt,[s("thead",Yt,[s("tr",null,[(d(!0),c(y,null,w(g.value,o=>(d(),c("th",{key:o,textContent:b(o),onClick:v=>m(o)},null,8,Ft))),128))])]),s("tbody",null,[(d(!0),c(y,null,w(p.value,o=>(d(),c("tr",{key:o.id,onClick:v=>E(o),class:C(F(o))},[(d(!0),c(y,null,w(g.value,v=>(d(),c("td",{key:v,textContent:b(o[v]),class:C(G(o,v))},null,10,Xt))),128))],10,Gt))),128))])])])):I("",!0),P(Pt,{show:M.value,data:j.value,onClose:Y},null,8,["show","data"]),s("pre",null,"        "+b(h.value[0])+`
    `,1)],64))}},Qt=D(Zt,[["__scopeId","data-v-abf72ead"]]),q=nt({});q.component("clean-data",Qt);q.use(lt);q.mount("#app");
