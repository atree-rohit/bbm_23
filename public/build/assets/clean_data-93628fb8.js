import{g as F,m as G,B as X,_ as A,o as u,c as p,b as a,F as f,l as x,n as $,t as _,C as T,D as y,E as w,G as L,w as I,v as Z,H as K,I as Q,h as V,d as D,p as tt,k as et,J as st,j as at,f as ot,s as nt}from"./_plugin-vue_export-helper-97672bd7.js";import{z as lt,m as P,i as it,s as C}from"./viridis-f5b5d56a.js";function O(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}const rt=F({name:"MapCleanData",props:{data:{type:Array,required:!0},modes:{type:Array,required:!0}},emits:["mode-change","polygon-clicked"],data(){return{mode:"districts",polygons:null,path:null,svg:null,projection:null,colors:null,max:null,height:500,width:500,zoomTransform:0,tooltip:null}},watch:{mode(t){this.$emit("mode-change",t)},data(t){console.log("data changed"),this.init()}},computed:{...G({geojson:t=>t.data.geojson}),current_geojson(){return!this.geojson||!this.mode?{}:this.geojson[this.mode]},zoom(){return lt().scaleExtent([.5,250]).translateExtent([[-.5*this.width,-.75*this.height],[2.5*this.width,2.5*this.height]]).on("zoom",this.handleZoom)},mode_key(){return{countries:"country",states:"state",districts:"district"}[this.mode]}},created(){this.geojson&&this.geojson.features&&(console.log("mounted: initializing"),this.init())},updated(){console.log("updated: re-initializing"),this.init()},methods:{init(){console.log("init"),this.current_geojson.features?(this.init_variables(),this.init_svg(),this.render_map()):console.log("No geojson")},init_variables(){this.polygons=null,this.path=null,this.svg={},this.height=window.innerHeight*.8,this.width=window.innerWidth*.5,window.innerWidth<800?(this.height=window.innerHeight*.6,this.projection=P().scale(600).center([110,20])):this.projection=P().scale(1e3).center([80,27.5]),this.path=it().projection(this.projection),this.tooltip=this.init_tooltip()},init_tooltip(){return C("body .d3-tooltip").empty()||C("body .d3-tooltip").remove(),C("body").append("div").attr("class","d3-tooltip").style("position","absolute").style("top","0").style("z-index","2000").style("visibility","hidden").style("padding","10px").style("background","rgba(0,0,0,0.75)").style("border-radius","4px").style("color","#fff").text("a simple tooltip")},init_svg(){C("#map-container svg.svg-content").empty()||C("#map-container svg.svg-content").remove(),this.svg=C("#map-container").append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("width",this.width).attr("height",this.height).classed("svg-content",!0),this.zoomTransform||(this.zoomTransform=X(this.svg.node()))},render_map(){let t=this.svg.append("g").classed("map-boundary",!0).selectAll("path").append("g");this.svg.append("g").classed("map-labels",!0).selectAll("text").append("g"),this.polygons=t.append("g").classed("polygons",!0),this.current_geojson.features.forEach(e=>{this.drawPolygon(e)}),this.drawPoints(),this.svg.call(this.zoom),this.svg.call(this.zoom.transform,this.zoomTransform)},drawPoints(){const t=this.svg.append("g").classed("points",!0),e=[];this.data.forEach(l=>{const{longitude:o,latitude:r}=l;if(r&&!isNaN(r)&&o&&!isNaN(o)){const[d,v]=this.projection([o,r]);t.append("circle").attr("cx",d).attr("cy",v).attr("r","10px").classed("point",!0)}else e.push(l)}),e.length&&console.warn("Missing Coordinates:",e)},drawPolygon(t){this.polygons.append("g").data([t]).enter().append("path").attr("d",this.path).classed("polygon",!0).on("mouseover",(e,l)=>{this.tooltip.html(this.hover_text(t.properties)).style("visibility","visible")}).on("mousemove",(e,l)=>{this.tooltip.style("top",e.pageY-10+"px").style("left",e.pageX+10+"px")}).on("mouseout",()=>this.tooltip.html("").style("visibility","hidden")).on("click",(e,l)=>this.clicked(l))},getPolygonId(t){let e=t.region,l=[" ","&","(",")","."];return t.state!=null&&(e=t.state),t.district!=null&&(e=t.district),l.forEach(o=>{e=e.replaceAll(o,"_")}),e},clicked(t){console.log(t);const{state:e,district:l}=t.properties;let o=[];e&&o.push(e),l&&o.push(l),o.length&&(o=o.join(" "),navigator.clipboard.writeText(o))},drawPolygonBoundary(t){this.polygons.append("g").data([t]).enter().append("path").classed("state-boundary",!0).classed("selected-polygon",e=>this.selected.state&&e.properties.state==this.selected.state||this.selected.region&&e.properties.region==this.selected.region).attr("properties",e=>JSON.stringify(e.properties)).attr("d",this.path).attr("id",this.getPolygonId(t.properties))},drawPolygonLabel(t,e){const l=this.regional_data[this.polygon_mode].find(r=>r[this.polygon_key]==e.properties[this.polygon_key]);let o="";l&&(o=this.format_number(l[this.data_mode])),t.append("g").data([e]).enter().append("text").classed("poly_text",!0).attr("x",r=>this.path.centroid(r)[0]).attr("y",r=>this.path.centroid(r)[1]).classed("small-text",!0).attr("text-anchor","middle").text(o).on("mouseover",()=>{this.tooltip.html(this.hover_text(e.properties)).style("visibility","visible")}).on("mousemove",(r,d)=>{this.tooltip.style("top",r.pageY-10+"px").style("left",r.pageX+10+"px")}).on("mouseout",()=>this.tooltip.html("").style("visibility","hidden")).on("click",(r,d)=>this.clicked(d))},color_polygon(t){let e=this.mapData.find(l=>l.name==t[this.mode_key]);return e?this.colors(e.value):this.colors(0)},handleZoom(t){this.zoomTransform=t.transform;let e=1/t.transform.k*.8;this.svg.selectAll(".poly_text").attr("transform",t.transform).style("font-size",`${e}rem`),this.svg.selectAll("path").attr("transform",t.transform),this.svg.selectAll("circle").attr("transform",t.transform).attr("r",e*5)},hover_text(t){let e=Object.entries(t).filter(([l,o])=>l!="id");return e=e.map(([l,o])=>`<tr><td>${O(l)}</td><td>${O(o)}</td></tr>`),`<table border='1' class='d3-tooltip'>${e.join(`
`)}</table>`},format_number(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}}),dt={class:"switcher switcher-sm text-center py-2 bg-dark"},ct=["onClick","textContent"],ut=a("div",{id:"map"},[a("div",{id:"map-container"})],-1);function pt(t,e,l,o,r,d){return u(),p(f,null,[a("div",dt,[(u(!0),p(f,null,x(t.modes,v=>(u(),p("button",{class:$(["btn mx-1",v===t.mode?"btn-success":"btn-outline-success bg-light"]),key:v,onClick:b=>t.mode=v,textContent:_(v)},null,10,ct))),128))]),ut],64)}const ht=A(rt,[["render",pt]]);const vt=t=>(tt("data-v-9272fce6"),t=t(),et(),t),mt={key:0,class:"modal fade show","aria-modal":"true",role:"dialog"},_t={class:"modal-dialog modal-lg"},gt={class:"modal-content"},bt={class:"modal-header"},ft={class:"modal-title",id:"exampleModalLiveLabel"},yt={class:"modal-body"},xt={class:"form-container"},kt=["onUpdate:modelValue"],Ct={for:"exampleInputEmail1",class:"form-label"},wt={class:"form-check form-switch"},$t=vt(()=>a("label",{class:"form-check-label",for:"flexSwitchCheckChecked"},"validated",-1)),jt={key:1,class:"modal-backdrop fade show"},Mt={name:"ModalEditObservation",props:{show:{type:Boolean,default:!1},data:{type:Object,required:!0}},mounted(){},computed:{show_map(){return this.data.latitude&&this.data.longitude&&(this.data.state==null||this.data.district==null)}},watch:{show(t){this.current_district_coordinator_id=0;let e=document.querySelector("body");t==!0?e.classList.add("modal-open"):e.classList.remove("modal-open")}},methods:{}},zt=Object.assign(Mt,{props:{show:{type:Boolean,default:!1},data:{type:Object,required:!0}},emits:["close"],setup(t,{emit:e}){const l=t,o=T(),r=()=>e("close"),d=y({}),v=["user","observed_on","place","country","state","district","latitude","longitude","taxa_id","species"];w(()=>l.data.state==null||l.data.district==null),L(()=>l.data,m=>{d.value=JSON.parse(JSON.stringify(m))});const b=m=>{const g={present:"border border-success",absent:"border border-danger"};if(m==="place"||m==="species")return"border border-secondary";const n=d.value[m];return m==="observed_on"?j(n)?g.present:g.absent:n&&typeof n=="string"&&n.length>1||typeof n=="number"&&n>0?g.present:g.absent},j=m=>!m||/^(202[0-3])-09-\d{2}$/.test(m),k=()=>{o.dispatch("clean_data/updateData",d.value),r()};return(m,g)=>(u(),p(f,null,[t.show?(u(),p("div",mt,[a("div",_t,[a("div",gt,[a("div",bt,[a("h3",ft,"Observation Details ["+_(t.data.portal)+" # "+_(t.data.id)+"]",1),a("button",{type:"button",class:"btn-close",onClick:r})]),a("div",yt,[a("div",xt,[(u(),p(f,null,x(v,n=>a("div",{class:"form-floating",key:n},[I(a("input",{class:$(["form-control",b(n)]),"onUpdate:modelValue":M=>d.value[n]=M},null,10,kt),[[Z,d.value[n]]]),a("label",Ct,_(K(O)(n)),1)])),64))]),a("div",wt,[I(a("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":g[0]||(g[0]=n=>d.value.validated=n)},null,512),[[Q,d.value.validated]]),$t]),a("div",null,[V(ht,{data:[d.value],modes:["countries","states","districts"]},null,8,["data"])])]),a("div",{class:"modal-footer"},[a("button",{type:"button",class:"btn btn-secondary",onClick:r},"Close"),a("button",{type:"button",class:"btn btn-success",onClick:k},"Save changes")])])])])):D("",!0),t.show?(u(),p("div",jt)):D("",!0)],64))}}),Nt=A(zt,[["__scopeId","data-v-9272fce6"]]);const St={class:"btn-rows bg-secondary"},Dt={class:"btn-group w-100 p-1"},Ot=["textContent","onClick"],At={class:"btn-group w-100 p-1"},Et=["textContent","onClick"],Bt={class:"page-info"},It={key:0,class:"table-container border border-danger"},Pt={class:"table table-sm table-hover"},Tt={class:"bg-dark text-light"},Lt=["textContent","onClick"],Vt=["onClick"],qt=["textContent"],Jt={__name:"CleanData",setup(t){const e=T(),l=["counts","inat","ibp","ifb"],o=y(null),r=["all","validated","unvalidated"],d=y("unvalidated"),v=y("id"),b=y("asc"),j=y(1e3),k=y(1),m=y(!1),g=y({});st(()=>{e.dispatch("data/getMaps")}),L(o,(i,h)=>{i!==h&&e.dispatch("clean_data/getData",i)});const n=w(()=>e.getters["clean_data/data_with_classes"]),M=w(()=>{let i=[];if(n&&n.value&&n.value[0])switch(d.value){case"all":i=n.value;break;case"validated":i=n.value.filter(h=>h.validated);break;case"unvalidated":i=n.value.filter(h=>!h.validated);break}return i}),q=w(()=>{const i=(k.value-1)*j.value,h=i+j.value;return M.value.slice(i,h)}),J=w(()=>n&&n.value&&n.value[0]?q.value.sort((i,h)=>{const s=i[v.value],c=h[v.value],S=N=>!isNaN(N),z=N=>typeof N=="boolean";return S(s)&&S(c)||z(s)&&z(c)?b.value==="asc"?s-c:c-s:b.value==="asc"?s.localeCompare(c):c.localeCompare(s)}):[]),B=w(()=>n&&n.value&&n.value[0]?["id","user","observed_on","place","country","state","district","latitude","longitude","taxa_id","species","validated"]:[]),U=i=>{v.value===i?b.value=b.value==="asc"?"desc":"asc":(v.value=i,b.value="asc"),console.log(i,v.value,b.value)},H=i=>{console.log(i),g.value={...i,portal:o.value},m.value=!0},R=()=>{g.value={},m.value=!1},W=i=>i.classes.all?"table-success":"table-danger",Y=(i,h)=>{const c={observed_on:"classes.date",user:"classes.user",country:"classes.location.country",state:"classes.location.state",district:"classes.location.district",latitude:"classes.location.latitude",longitude:"classes.location.longitude",taxa_id:"classes.taxon.taxa_id",species:"classes.taxon.species",validated:"validated"}[h];return c?c.split(".").reduce((z,N)=>z&&z[N],i)?"table-success":"table-danger":"table-warning"};return(i,h)=>(u(),p(f,null,[a("div",St,[a("div",Dt,[(u(),p(f,null,x(l,s=>a("button",{class:$(["btn btn-sm mx-2 rounded",{"btn-success":s===o.value,"btn-outline-light":s!==o.value}]),key:s,textContent:_(s),onClick:c=>o.value=o.value==s?null:s},null,10,Ot)),64))]),a("div",At,[(u(),p(f,null,x(r,s=>a("button",{class:$(["btn btn-sm mx-2 rounded",{"btn-success":s===d.value,"btn-outline-light":s!==d.value}]),key:s,textContent:_(s),onClick:c=>d.value=d.value==s?null:s},null,10,Et)),64))]),a("div",Bt,[a("button",{class:"btn btn-sm btn-info",onClick:h[0]||(h[0]=s=>k.value--)}," < "),a("span",null,"Page "+_(k.value)+" of "+_(Math.ceil(M.value.length/j.value)),1),a("button",{class:"btn btn-sm btn-info",onClick:h[1]||(h[1]=s=>k.value++)}," > "),at(" Total Records: "+_(M.value.length),1)])]),o.value?(u(),p("div",It,[a("table",Pt,[a("thead",Tt,[a("tr",null,[(u(!0),p(f,null,x(B.value,s=>(u(),p("th",{key:s,textContent:_(s),onClick:c=>U(s)},null,8,Lt))),128))])]),a("tbody",null,[(u(!0),p(f,null,x(J.value,s=>(u(),p("tr",{key:s.id,onClick:c=>H(s),class:$(W(s))},[(u(!0),p(f,null,x(B.value,c=>(u(),p("td",{key:c,textContent:_(s[c]),class:$(Y(s,c))},null,10,qt))),128))],10,Vt))),128))])])])):D("",!0),V(Nt,{show:m.value,data:g.value,onClose:R},null,8,["show","data"]),a("pre",null,"        "+_(n.value[0])+`
    `,1)],64))}},Ut=A(Jt,[["__scopeId","data-v-3f402939"]]),E=ot({});E.component("clean-data",Ut);E.use(nt);E.mount("#app");
